{% extends 'base.html' %}

{% block content %}

<style>
/* ── Dashboard specific styles ── */
@import url('https://fonts.googleapis.com/css2?family=Syne:wght@600;700;800&display=swap');

/* Animated number counter */
.stat-value { transition: all 0.3s; }

/* ── KPI Cards ── */
.kpi-card {
    border-radius: 18px !important;
    border: none !important;
    overflow: hidden;
    position: relative;
    cursor: default;
    transition: transform 0.3s cubic-bezier(0.34,1.56,0.64,1), box-shadow 0.3s;
    animation: cardPop 0.5s cubic-bezier(0.34,1.56,0.64,1) both;
}
.kpi-card:nth-child(1) { animation-delay: 0.05s; }
.kpi-card:nth-child(2) { animation-delay: 0.12s; }
.kpi-card:nth-child(3) { animation-delay: 0.19s; }
.kpi-card:nth-child(4) { animation-delay: 0.26s; }

@keyframes cardPop {
    from { opacity:0; transform: translateY(24px) scale(0.95); }
    to   { opacity:1; transform: translateY(0) scale(1); }
}

.kpi-card:hover {
    transform: translateY(-6px) scale(1.02);
    box-shadow: 0 16px 40px rgba(0,0,0,0.13) !important;
}

.kpi-card .card-body {
    padding: 1.1rem 1.1rem 1rem;
    position: relative;
    z-index: 1;
    overflow: hidden;
}
.kpi-card .card-body > .d-flex {
    min-width: 0;
    overflow: hidden;
}
.kpi-card .stat-text {
    min-width: 0;
    flex: 1;
    overflow: hidden;
}

/* Gradient top bar on each card */
.kpi-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 4px;
    border-radius: 18px 18px 0 0;
}
.kpi-blue::before   { background: linear-gradient(90deg,#1a56db,#38bdf8); }
.kpi-green::before  { background: linear-gradient(90deg,#059669,#34d399); }
.kpi-amber::before  { background: linear-gradient(90deg,#d97706,#fbbf24); }
.kpi-red::before    { background: linear-gradient(90deg,#dc2626,#f87171); }

/* Decorative circle bg in card */
.kpi-card .deco-circle {
    position: absolute;
    width: 110px; height: 110px;
    border-radius: 50%;
    right: -20px; bottom: -25px;
    opacity: 0.06;
    z-index: 0;
}
.kpi-blue .deco-circle   { background: #1a56db; }
.kpi-green .deco-circle  { background: #059669; }
.kpi-amber .deco-circle  { background: #d97706; }
.kpi-red .deco-circle    { background: #dc2626; }

.kpi-label {
    font-size: 0.72rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: #6b7280;
    margin-bottom: 6px;
}
.kpi-number {
    font-family: 'Syne', sans-serif;
    font-size: 1.5rem;
    font-weight: 800;
    line-height: 1;
    margin-bottom: 0;
    letter-spacing: -0.5px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
}
.kpi-blue  .kpi-number { color: #1a56db; }
.kpi-green .kpi-number { color: #059669; }
.kpi-amber .kpi-number { color: #b45309; }
.kpi-red   .kpi-number { color: #dc2626; }

.kpi-icon-wrap {
    width: 46px; height: 46px;
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.2rem;
    flex-shrink: 0;
}
.kpi-blue  .kpi-icon-wrap { background: #eff6ff; color: #1a56db; }
.kpi-green .kpi-icon-wrap { background: #ecfdf5; color: #059669; }
.kpi-amber .kpi-icon-wrap { background: #fffbeb; color: #d97706; }
.kpi-red   .kpi-icon-wrap { background: #fef2f2; color: #dc2626; }

.kpi-trend {
    font-size: 0.75rem;
    margin-top: 8px;
    display: flex;
    align-items: center;
    gap: 4px;
}

/* ── Chart cards ── */
.chart-card {
    border-radius: 18px !important;
    border: none !important;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06) !important;
    animation: fadeSlideUp 0.6s cubic-bezier(0.16,1,0.3,1) 0.3s both;
    overflow: hidden;
}

@keyframes fadeSlideUp {
    from { opacity:0; transform:translateY(30px); }
    to   { opacity:1; transform:translateY(0); }
}

.chart-card .card-header {
    background: #ffffff !important;
    border-bottom: 1px solid #f3f4f6 !important;
    padding: 1rem 1.3rem !important;
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.chart-card .card-header h6 {
    font-size: 0.875rem;
    font-weight: 700;
    color: #111827;
    margin: 0;
}
.chart-card .card-header .badge-pill {
    font-size: 0.68rem;
    padding: 4px 10px;
    border-radius: 20px;
    background: #f3f4f6;
    color: #6b7280;
    font-weight: 500;
}

/* ── Bottom table cards ── */
.table-card {
    border-radius: 18px !important;
    border: none !important;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06) !important;
    animation: fadeSlideUp 0.6s cubic-bezier(0.16,1,0.3,1) both;
    overflow: hidden;
}
.table-card:nth-child(1) { animation-delay: 0.4s; }
.table-card:nth-child(2) { animation-delay: 0.5s; }
.table-card:nth-child(3) { animation-delay: 0.6s; }

.table-card .card-header {
    background: #ffffff !important;
    border-bottom: 1px solid #f3f4f6 !important;
    padding: 0.9rem 1.2rem !important;
}
.table-card .card-header h6 {
    font-size: 0.83rem;
    font-weight: 700;
    color: #111827;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 8px;
}

.table-card table thead th {
    font-size: 0.68rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.7px;
    color: #9ca3af;
    background: #f9fafb;
    border-bottom: 1px solid #f3f4f6;
    padding: 8px 12px;
}
.table-card table tbody td {
    font-size: 0.825rem;
    padding: 9px 12px;
    color: #374151;
    border-bottom: 1px solid #f9fafb;
    vertical-align: middle;
}
.table-card table tbody tr:last-child td { border-bottom: none; }
.table-card table tbody tr {
    transition: background 0.15s;
}
.table-card table tbody tr:hover td { background: #f9fafb; }

/* Rank badges */
.rank-1 { background: linear-gradient(135deg,#f59e0b,#fbbf24); color:#fff; font-weight:700; }
.rank-2 { background: #e5e7eb; color: #4b5563; }
.rank-3 { background: #fde8d0; color: #92400e; }

/* Low stock row */
.stock-critical td { background: #fff5f5 !important; }
.stock-critical td:first-child { border-left: 3px solid #ef4444; }

/* Pulse dot */
.live-dot {
    display: inline-block;
    width: 8px; height: 8px;
    background: #22c55e;
    border-radius: 50%;
    margin-right: 6px;
    position: relative;
}
.live-dot::after {
    content: '';
    position: absolute;
    inset: -3px;
    border-radius: 50%;
    border: 2px solid #22c55e;
    animation: ripple 1.5s ease-out infinite;
    opacity: 0;
}
@keyframes ripple {
    0%   { transform:scale(0.6); opacity:0.8; }
    100% { transform:scale(2);   opacity:0; }
}

/* Section label */
.section-label {
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    color: #9ca3af;
    margin-bottom: 10px;
    margin-top: 4px;
}

/* Shimmer loading for charts */
.chart-placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 220px;
    color: #d1d5db;
    font-size: 0.85rem;
    flex-direction: column;
    gap: 8px;
}
.chart-placeholder i { font-size: 2rem; opacity: 0.3; }
</style>

<!-- ── Section: KPI Row ── -->
<p class="section-label">Overview</p>
<div class="row g-3 mb-4">

    <div class="col-6 col-xl-3">
        <div class="card kpi-card kpi-blue shadow-sm h-100">
            <div class="deco-circle"></div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="kpi-icon-wrap"><i class="bi bi-box-seam-fill"></i></div>
                    <span class="badge" style="background:#eff6ff;color:#1a56db;font-size:0.68rem;padding:4px 8px;border-radius:8px;">Total</span>
                </div>
                <div class="kpi-label">Products</div>
                <div class="kpi-number" data-target="{{ stats.total_products }}">{{ stats.total_products }}</div>
                <div class="kpi-trend text-muted"><i class="bi bi-arrow-up-right text-success"></i> Active inventory items</div>
            </div>
        </div>
    </div>

    <div class="col-6 col-xl-3">
        <div class="card kpi-card kpi-green shadow-sm h-100">
            <div class="deco-circle"></div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="kpi-icon-wrap"><i class="bi bi-currency-rupee"></i></div>
                    <span class="badge" style="background:#ecfdf5;color:#059669;font-size:0.68rem;padding:4px 8px;border-radius:8px;">Value</span>
                </div>
                <div class="kpi-label">Stock Value</div>
                <div class="kpi-number">&#8377;{{ stats.total_stock_value|floatformat:0 }}</div>
                <div class="kpi-trend text-muted"><i class="bi bi-database text-success"></i> Total inventory worth</div>
            </div>
        </div>
    </div>

    <div class="col-6 col-xl-3">
        <div class="card kpi-card kpi-amber shadow-sm h-100">
            <div class="deco-circle"></div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="kpi-icon-wrap"><i class="bi bi-graph-up-arrow"></i></div>
                    <span class="badge" style="background:#fffbeb;color:#d97706;font-size:0.68rem;padding:4px 8px;border-radius:8px;">30 Days</span>
                </div>
                <div class="kpi-label">Revenue</div>
                <div class="kpi-number">&#8377;{{ stats.monthly_revenue|floatformat:0 }}</div>
                <div class="kpi-trend text-muted"><i class="bi bi-calendar3 text-warning"></i> This month's earnings</div>
            </div>
        </div>
    </div>

    <div class="col-6 col-xl-3">
        <div class="card kpi-card kpi-red shadow-sm h-100 {% if stats.low_stock_count > 0 %}border border-danger{% endif %}">
            <div class="deco-circle"></div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="kpi-icon-wrap"><i class="bi bi-exclamation-triangle-fill"></i></div>
                    {% if stats.low_stock_count > 0 %}
                    <span class="badge" style="background:#fef2f2;color:#dc2626;font-size:0.68rem;padding:4px 8px;border-radius:8px;">&#9888; Alert</span>
                    {% else %}
                    <span class="badge" style="background:#ecfdf5;color:#059669;font-size:0.68rem;padding:4px 8px;border-radius:8px;">&#10003; OK</span>
                    {% endif %}
                </div>
                <div class="kpi-label">Low Stock</div>
                <div class="kpi-number">{{ stats.low_stock_count }}</div>
                <div class="kpi-trend text-muted"><i class="bi bi-bell text-danger"></i> Items need restocking</div>
            </div>
        </div>
    </div>

</div>

<!-- ── Section: Charts ── -->
<p class="section-label">Analytics</p>
<div class="row g-3 mb-4">

    <div class="col-lg-8">
        <div class="card chart-card h-100">
            <div class="card-header">
                <h6><i class="bi bi-activity text-primary me-2"></i>Monthly Revenue Trend</h6>
                <span class="badge-pill">Last 90 days</span>
            </div>
            <div class="card-body" id="lineChartContainer" style="padding:1.2rem;">
                <div class="chart-placeholder" id="linePlaceholder">
                    <i class="bi bi-bar-chart-line"></i>
                    <span>Loading chart...</span>
                </div>
                <canvas id="monthlyRevenueChart" height="100" style="display:none;"></canvas>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card chart-card h-100">
            <div class="card-header">
                <h6><i class="bi bi-pie-chart-fill text-success me-2"></i>Sales by Category</h6>
                <span class="badge-pill">All time</span>
            </div>
            <div class="card-body d-flex align-items-center justify-content-center" id="pieChartContainer" style="padding:1rem;">
                <div class="chart-placeholder" id="piePlaceholder">
                    <i class="bi bi-pie-chart"></i>
                    <span>Loading chart...</span>
                </div>
                <canvas id="categoryPieChart" style="display:none;"></canvas>
            </div>
        </div>
    </div>

</div>

<!-- ── Section: Tables ── -->
<p class="section-label">Details</p>
<div class="row g-3">

    <!-- Fast Moving -->
    <div class="col-md-4">
        <div class="card table-card h-100">
            <div class="card-header">
                <h6>
                    <span style="background:linear-gradient(135deg,#f59e0b,#fbbf24);width:28px;height:28px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center;color:#fff;font-size:0.8rem;">&#9889;</span>
                    Fast-Moving
                    <span class="ms-auto badge" style="background:#fff7ed;color:#c2410c;font-size:0.7rem;padding:3px 8px;border-radius:8px;font-weight:600;">30 days</span>
                </h6>
            </div>
            <div class="card-body p-0">
                <table class="table mb-0">
                    <thead><tr><th>Rank</th><th>Product</th><th class="text-end">Units</th></tr></thead>
                    <tbody>
                        {% for item in fast_moving %}
                        <tr>
                            <td>
                                {% if forloop.counter == 1 %}<span class="badge rank-1" style="border-radius:8px;width:26px;height:26px;display:inline-flex;align-items:center;justify-content:center;">1</span>
                                {% elif forloop.counter == 2 %}<span class="badge rank-2" style="border-radius:8px;width:26px;height:26px;display:inline-flex;align-items:center;justify-content:center;">2</span>
                                {% elif forloop.counter == 3 %}<span class="badge rank-3" style="border-radius:8px;width:26px;height:26px;display:inline-flex;align-items:center;justify-content:center;">3</span>
                                {% else %}<span class="badge" style="background:#f3f4f6;color:#6b7280;border-radius:8px;width:26px;height:26px;display:inline-flex;align-items:center;justify-content:center;">{{ forloop.counter }}</span>{% endif %}
                            </td>
                            <td style="font-weight:500;">{{ item.product }}</td>
                            <td class="text-end"><span style="background:#fff7ed;color:#c2410c;padding:2px 8px;border-radius:6px;font-weight:700;font-size:0.8rem;">{{ item.quantity_sold }}</span></td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="3" class="text-center text-muted py-4" style="font-size:0.82rem;">No sales data yet</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Low Stock -->
    <div class="col-md-4">
        <div class="card table-card h-100">
            <div class="card-header">
                <h6>
                    <span style="background:linear-gradient(135deg,#ef4444,#f87171);width:28px;height:28px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center;color:#fff;font-size:0.8rem;">&#9888;</span>
                    Low Stock
                    {% if stats.low_stock_count > 0 %}
                    <span class="ms-auto badge" style="background:#fef2f2;color:#dc2626;font-size:0.7rem;padding:3px 8px;border-radius:8px;font-weight:600;">{{ stats.low_stock_count }} alerts</span>
                    {% else %}
                    <span class="ms-auto badge" style="background:#ecfdf5;color:#059669;font-size:0.7rem;padding:3px 8px;border-radius:8px;">All OK</span>
                    {% endif %}
                </h6>
            </div>
            <div class="card-body p-0">
                <table class="table mb-0">
                    <thead><tr><th>Product</th><th class="text-center">Stock</th><th class="text-center">Min</th></tr></thead>
                    <tbody>
                        {% for item in low_stock %}
                        <tr class="stock-critical">
                            <td style="font-weight:500;">{{ item.name|truncatechars:16 }}</td>
                            <td class="text-center"><span style="background:#fef2f2;color:#dc2626;padding:2px 8px;border-radius:6px;font-weight:700;font-size:0.8rem;">{{ item.quantity }}</span></td>
                            <td class="text-center text-muted">{{ item.threshold }}</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="3" class="text-center py-4" style="color:#22c55e;font-size:0.82rem;"><i class="bi bi-check-circle-fill me-1"></i>All stocked up!</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Recent Sales -->
    <div class="col-md-4">
        <div class="card table-card h-100">
            <div class="card-header">
                <h6>
                    <span class="live-dot"></span>
                    Recent Sales
                    <span class="ms-auto badge" style="background:#f0fdf4;color:#16a34a;font-size:0.7rem;padding:3px 8px;border-radius:8px;font-weight:600;">Live</span>
                </h6>
            </div>
            <div class="card-body p-0">
                <table class="table mb-0">
                    <thead><tr><th>Product</th><th class="text-center">Qty</th><th class="text-end">Date</th></tr></thead>
                    <tbody>
                        {% for sale in recent_sales %}
                        <tr>
                            <td style="font-weight:500;">{{ sale.product.name|truncatechars:16 }}</td>
                            <td class="text-center"><span style="background:#f0f9ff;color:#0369a1;padding:2px 8px;border-radius:6px;font-weight:700;font-size:0.8rem;">{{ sale.quantity_sold }}</span></td>
                            <td class="text-end text-muted" style="font-size:0.78rem;">{{ sale.sale_date|date:"d M" }}</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="3" class="text-center text-muted py-4" style="font-size:0.82rem;">No sales yet</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

{% endblock %}

{% block extra_js %}
<script>
window.addEventListener('load', function () {
    if (typeof Chart === 'undefined') return;

    fetch("{% url 'api_chart_data' %}")
        .then(r => r.json())
        .then(function(data) {

            // ── Line Chart ──
            var lineCanvas = document.getElementById('monthlyRevenueChart');
            var linePH = document.getElementById('linePlaceholder');
            if (data.monthly.labels.length > 0) {
                linePH.style.display = 'none';
                lineCanvas.style.display = 'block';
                new Chart(lineCanvas.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: data.monthly.labels,
                        datasets: [{
                            label: 'Revenue',
                            data: data.monthly.revenues,
                            borderColor: '#1a56db',
                            backgroundColor: 'rgba(26,86,219,0.08)',
                            borderWidth: 2.5,
                            pointBackgroundColor: '#1a56db',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 5,
                            pointHoverRadius: 8,
                            fill: true,
                            tension: 0.45
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: '#1e293b',
                                titleColor: '#94a3b8',
                                bodyColor: '#f1f5f9',
                                padding: 12,
                                cornerRadius: 10,
                                callbacks: {
                                    label: ctx => ' \u20B9' + Number(ctx.raw).toLocaleString('en-IN')
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: 'rgba(0,0,0,0.04)', drawBorder: false },
                                ticks: {
                                    color: '#9ca3af',
                                    font: { size: 11 },
                                    callback: v => '\u20B9' + (v >= 1000 ? (v/1000).toFixed(0)+'K' : v)
                                }
                            },
                            x: {
                                grid: { display: false, drawBorder: false },
                                ticks: { color: '#9ca3af', font: { size: 11 } }
                            }
                        }
                    }
                });
            } else {
                linePH.innerHTML = '<i class="bi bi-bar-chart-line"></i><span>No data yet. Record some sales!</span>';
            }

            // ── Pie Chart ──
            var pieCanvas = document.getElementById('categoryPieChart');
            var piePH = document.getElementById('piePlaceholder');
            if (data.categories.labels.length > 0) {
                piePH.style.display = 'none';
                pieCanvas.style.display = 'block';
                new Chart(pieCanvas.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: data.categories.labels,
                        datasets: [{
                            data: data.categories.revenues,
                            backgroundColor: ['#1a56db','#38bdf8','#059669','#d97706','#8b5cf6','#ec4899'],
                            borderWidth: 3,
                            borderColor: '#fff',
                            hoverBorderWidth: 0,
                            hoverOffset: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        cutout: '65%',
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: '#374151',
                                    font: { size: 11 },
                                    padding: 14,
                                    usePointStyle: true,
                                    pointStyleWidth: 8
                                }
                            },
                            tooltip: {
                                backgroundColor: '#1e293b',
                                titleColor: '#94a3b8',
                                bodyColor: '#f1f5f9',
                                cornerRadius: 10,
                                callbacks: {
                                    label: ctx => ' \u20B9' + Number(ctx.raw).toLocaleString('en-IN')
                                }
                            }
                        }
                    }
                });
            } else {
                piePH.innerHTML = '<i class="bi bi-pie-chart"></i><span>No sales data yet</span>';
            }
        })
        .catch(function(err) {
            console.error('Chart error:', err);
        });
});
</script>
{% endblock %}