{% extends 'base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white py-3">
                <h5 class="fw-bold mb-0"><i class="bi bi-cart-plus text-success"></i> Record a Sale</h5>
            </div>
            <div class="card-body p-4">

                {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    {% for error in form.non_field_errors %}{{ error }}{% endfor %}
                </div>
                {% endif %}

                <form method="post" id="saleForm">
                    {% csrf_token %}

                    <div class="mb-3">
                        <label class="form-label fw-semibold">Select Product *</label>
                        {{ form.product }}
                        {% if form.product.errors %}<div class="text-danger small">{{ form.product.errors }}</div>{% endif %}
                    </div>

                    <!-- Stock info (auto-filled by JS) -->
                    <div id="stockInfo" class="alert alert-info d-none mb-3">
                        <span id="stockText"></span>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">Quantity to Sell *</label>
                        {{ form.quantity_sold }}
                        {% if form.quantity_sold.errors %}<div class="text-danger small">{{ form.quantity_sold.errors }}</div>{% endif %}
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">Sale Price per Unit (&#8377;) *</label>
                        {{ form.sale_price }}
                        <small class="text-muted">Auto-filled from product price. You can override.</small>
                        {% if form.sale_price.errors %}<div class="text-danger small">{{ form.sale_price.errors }}</div>{% endif %}
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-semibold">Notes (optional)</label>
                        {{ form.notes }}
                    </div>

                    <button type="submit" class="btn btn-success w-100 py-2">
                        <i class="bi bi-check-lg"></i> Confirm & Record Sale
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>

document.getElementById('id_product').addEventListener('change', function () {
    const productId = this.value;
    if (!productId) return;

    fetch(`/api/product-price/?product_id=${productId}`)
        .then(res => res.json())
        .then(data => {
            document.getElementById('id_sale_price').value = data.price;

            const stockBox = document.getElementById('stockInfo');
            const stockText = document.getElementById('stockText');
            stockBox.classList.remove('d-none');

            if (data.stock <= 10) {
                stockBox.className = 'alert alert-warning mb-3';
            } else {
                stockBox.className = 'alert alert-info mb-3';
            }
            stockText.innerHTML = `<strong>${data.name}</strong> â€” Available Stock: <strong>${data.stock}</strong> units`;
        })
        .catch(err => console.error('Error:', err));
});
</script>
{% endblock %}
